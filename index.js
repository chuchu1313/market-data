const express = require('express');
const ccxt = require('ccxt');
const { MACD, RSI, SMA } = require('technicalindicators');

const app = express();
const exchange = new ccxt.binance();

app.get('/', async (req, res) => {
    res.writeHead(200);
    res.end('OK 200');
});

app.get('/api/market-data', async (req, res) => {
    try {
        res.json({
            "symbol": "BTC/USDT",
            "timeframe": "5m",
            "timestamp": [
                "2025-03-17T01:20:00.000Z",
                "2025-03-17T01:25:00.000Z",
                "2025-03-17T01:30:00.000Z",
                "2025-03-17T01:35:00.000Z",
                "2025-03-17T01:40:00.000Z",
                "2025-03-17T01:45:00.000Z",
                "2025-03-17T01:50:00.000Z",
                "2025-03-17T01:55:00.000Z",
                "2025-03-17T02:00:00.000Z",
                "2025-03-17T02:05:00.000Z",
                "2025-03-17T02:10:00.000Z",
                "2025-03-17T02:15:00.000Z",
                "2025-03-17T02:20:00.000Z",
                "2025-03-17T02:25:00.000Z",
                "2025-03-17T02:30:00.000Z",
                "2025-03-17T02:35:00.000Z",
                "2025-03-17T02:40:00.000Z",
                "2025-03-17T02:45:00.000Z",
                "2025-03-17T02:50:00.000Z",
                "2025-03-17T02:55:00.000Z",
                "2025-03-17T03:00:00.000Z",
                "2025-03-17T03:05:00.000Z",
                "2025-03-17T03:10:00.000Z",
                "2025-03-17T03:15:00.000Z",
                "2025-03-17T03:20:00.000Z",
                "2025-03-17T03:25:00.000Z",
                "2025-03-17T03:30:00.000Z",
                "2025-03-17T03:35:00.000Z",
                "2025-03-17T03:40:00.000Z",
                "2025-03-17T03:45:00.000Z",
                "2025-03-17T03:50:00.000Z",
                "2025-03-17T03:55:00.000Z",
                "2025-03-17T04:00:00.000Z",
                "2025-03-17T04:05:00.000Z",
                "2025-03-17T04:10:00.000Z"
            ],
            "ohlcv": [
                [
                    82878,
                    83010.57,
                    82833.38,
                    83010.56,
                    34.53193
                ],
                [
                    83010.56,
                    83020,
                    82944.42,
                    82955.02,
                    43.07148
                ],
                [
                    82955.02,
                    83131.3,
                    82955.02,
                    83101.26,
                    41.09239
                ],
                [
                    83101.26,
                    83233,
                    83101.26,
                    83150,
                    62.75352
                ],
                [
                    83150.01,
                    83243.73,
                    83122.98,
                    83186.01,
                    50.94285
                ],
                [
                    83186,
                    83400,
                    83181.05,
                    83292.29,
                    81.56798
                ],
                [
                    83292.3,
                    83341.62,
                    83246.98,
                    83284.36,
                    32.22071
                ],
                [
                    83284.36,
                    83308.47,
                    83208.82,
                    83233.8,
                    22.69745
                ],
                [
                    83233.8,
                    83246.98,
                    83116.32,
                    83171.24,
                    39.5835
                ],
                [
                    83171.24,
                    83224.54,
                    83132.11,
                    83170.28,
                    37.7445
                ],
                [
                    83170.28,
                    83174.12,
                    83049.2,
                    83049.2,
                    22.71911
                ],
                [
                    83049.21,
                    83149.69,
                    82981.68,
                    83136.95,
                    46.31951
                ],
                [
                    83136.96,
                    83191.98,
                    83086.2,
                    83187.54,
                    24.19574
                ],
                [
                    83187.54,
                    83290.44,
                    83187.53,
                    83268.34,
                    25.70455
                ],
                [
                    83268.34,
                    83280.11,
                    83188.31,
                    83224.54,
                    24.02651
                ],
                [
                    83224.54,
                    83262.5,
                    83185.27,
                    83262.49,
                    10.24202
                ],
                [
                    83262.49,
                    83336.11,
                    83239.12,
                    83325.88,
                    29.58352
                ],
                [
                    83325.89,
                    83375.35,
                    83143.97,
                    83158.91,
                    57.6813
                ],
                [
                    83158.92,
                    83250.08,
                    83158.91,
                    83159.44,
                    24.28235
                ],
                [
                    83159.43,
                    83284.02,
                    83159.43,
                    83212.51,
                    22.57374
                ],
                [
                    83212.51,
                    83465.77,
                    83212.5,
                    83395.46,
                    61.07639
                ],
                [
                    83395.46,
                    83615.41,
                    83387.38,
                    83465.31,
                    109.87958
                ],
                [
                    83465.31,
                    83500.02,
                    83425.39,
                    83500.01,
                    25.84761
                ],
                [
                    83500,
                    83608.8,
                    83479.93,
                    83498.81,
                    83.96857
                ],
                [
                    83498.81,
                    83559.75,
                    83451.97,
                    83550,
                    56.85627
                ],
                [
                    83549.99,
                    83550,
                    83486.43,
                    83486.43,
                    29.0753
                ],
                [
                    83486.44,
                    83530.41,
                    83468.62,
                    83468.62,
                    33.94893
                ],
                [
                    83468.63,
                    83492,
                    83384.65,
                    83492,
                    53.81747
                ],
                [
                    83492.01,
                    83532.78,
                    83456.99,
                    83481.61,
                    83.91365
                ],
                [
                    83481.61,
                    83583.47,
                    83478.03,
                    83543.23,
                    74.39639
                ],
                [
                    83543.24,
                    83681.5,
                    83543.23,
                    83645.09,
                    59.42803
                ],
                [
                    83645.09,
                    83725.39,
                    83645.04,
                    83675.65,
                    36.74552
                ],
                [
                    83675.64,
                    83869.77,
                    83675.64,
                    83839.7,
                    57.7163
                ],
                [
                    83839.7,
                    83854.68,
                    83749.41,
                    83751.57,
                    27.54707
                ],
                [
                    83751.57,
                    83821.33,
                    83694.34,
                    83694.34,
                    37.38415
                ]
            ],
            "indicators": {
                "macd": [
                    {
                        "MACD": 106.14160168159287
                    },
                    {
                        "MACD": 99.6850239080959
                    },
                    {
                        "MACD": 97.52610942562751
                    },
                    {
                        "MACD": 101.1688276011846
                    },
                    {
                        "MACD": 99.37587087147404
                    },
                    {
                        "MACD": 99.86599456334079
                    },
                    {
                        "MACD": 104.16867273146636
                    },
                    {
                        "MACD": 93.03306533917203
                    },
                    {
                        "MACD": 83.29065994248958,
                        "signal": 98.25064734049374,
                        "histogram": -14.95998739800416
                    },
                    {
                        "MACD": 78.94204420498863,
                        "signal": 94.38892671339272,
                        "histogram": -15.446882508404087
                    },
                    {
                        "MACD": 89.22968664193468,
                        "signal": 93.35707869910111,
                        "histogram": -4.127392057166432
                    },
                    {
                        "MACD": 101.8450226066052,
                        "signal": 95.05466748060192,
                        "histogram": 6.790355126003277
                    },
                    {
                        "MACD": 113.33629696516437,
                        "signal": 98.71099337751441,
                        "histogram": 14.625303587649952
                    },
                    {
                        "MACD": 120.95212391884706,
                        "signal": 103.15921948578094,
                        "histogram": 17.792904433066127
                    },
                    {
                        "MACD": 129.62410088918114,
                        "signal": 108.45219576646097,
                        "histogram": 21.171905122720162
                    },
                    {
                        "MACD": 129.8700759982603,
                        "signal": 112.73577181282084,
                        "histogram": 17.134304185439447
                    },
                    {
                        "MACD": 127.16204993274005,
                        "signal": 115.62102743680468,
                        "histogram": 11.541022495935366
                    },
                    {
                        "MACD": 125.45630814429023,
                        "signal": 117.58808357830179,
                        "histogram": 7.8682245659884416
                    },
                    {
                        "MACD": 121.86136733402964,
                        "signal": 118.44274032944736,
                        "histogram": 3.4186270045822766
                    },
                    {
                        "MACD": 122.57164029082924,
                        "signal": 119.26852032172374,
                        "histogram": 3.303119969105495
                    },
                    {
                        "MACD": 129.85687818816223,
                        "signal": 121.38619189501144,
                        "histogram": 8.470686293150791
                    },
                    {
                        "MACD": 136.5226699517225,
                        "signal": 124.41348750635365,
                        "histogram": 12.109182445368845
                    },
                    {
                        "MACD": 153.27595216019836,
                        "signal": 130.1859804371226,
                        "histogram": 23.089971723075763
                    },
                    {
                        "MACD": 157.6246951764042,
                        "signal": 135.67372338497893,
                        "histogram": 21.950971791425275
                    },
                    {
                        "MACD": 154.6701810702798,
                        "signal": 139.4730149220391,
                        "histogram": 15.197166148240683
                    }
                ],
                "rsi": [
                    63.22,
                    59.67,
                    65.21,
                    66.85,
                    68.04,
                    71.33,
                    70.74,
                    66.98,
                    62.54,
                    62.47,
                    54.39,
                    58.57,
                    60.8,
                    64.13,
                    61.1,
                    62.74,
                    65.37,
                    54.47,
                    54.5,
                    57.13,
                    64.71,
                    67.1,
                    68.25,
                    68.16,
                    69.96,
                    65.05,
                    63.7,
                    64.74,
                    63.87,
                    66.72,
                    70.83,
                    71.95,
                    77.04,
                    69.72,
                    65.38
                ],
                "sma_50": [
                    83215.3454
                ]
            }
        });
        return;
        const symbol = req.query.symbol || 'BTC/USDT';
        const timeframe = req.query.timeframe || '5m';
        const limit = 50; // 确保获取足够的数据

        const ohlcv = await exchange.fetchOHLCV(symbol, timeframe, undefined, limit);
        const timestamps = ohlcv.map(candle => new Date(candle[0]).toISOString());
        const closes = ohlcv.map(candle => candle[4]);

        // 计算 MACD
        const macdInput = { values: closes, fastPeriod: 12, slowPeriod: 26, signalPeriod: 9 };
        const macdResult = MACD.calculate(macdInput);

        // calculate RSI
        const rsiResult = RSI.calculate({ values: closes, period: 14 });

        // calculate SMA(50)
        const sma50Result = SMA.calculate({ values: closes, period: 50 });

        const minDataSize = Math.min(macdResult.length, rsiResult.length, closes.length);

        // get recent 35 data points
        const sliceSize = Math.max(35, minDataSize);
        const macdFormatted = macdResult.slice(-sliceSize).map((val) => ({
            MACD: val.MACD,
            signal: val.signal,
            histogram: val.histogram
        }));

        res.json({
            symbol,
            timeframe,
            timestamp: timestamps.slice(-sliceSize),
            ohlcv: ohlcv.slice(-sliceSize).map(candle => candle.slice(1, 6)), // 取 open, high, low, close, volume
            indicators: {
                macd: macdFormatted,
                rsi: rsiResult.slice(-sliceSize),
                sma_50: sma50Result.slice(-sliceSize)
            }
        });

    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.listen(3000);

app.on('SIGTERM', () => app.close());
